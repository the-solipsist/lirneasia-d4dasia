name: Render and Publish Reports

on:
  push:
    # Trigger on main AND any branch starting with "test"
    branches: [ 'main', 'test*' ]
    paths:
      - 'country/**/*.qmd'
      - '_quarto.yml'
      - '_extensions/**'
      - 'shared/**'
      - '_scripts/**'
      - '.github/workflows/publish-reports.yml'
  workflow_dispatch:

permissions:
  contents: write # Required for releases

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Check out Fonts
        uses: actions/checkout@v4
        with:
          repository: the-solipsist/fonts 
          path: font-repo
          ref: main

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: pre-release

      - name: Prepare Scripts
        run: chmod +x main-repo/_scripts/link-pdfs.sh

      - name: Install Custom Fonts
        run: |
          sudo apt-get update && sudo apt-get install -y fontconfig
          mkdir -p ~/.local/share/fonts
          cp -r font-repo/*.ttf ~/.local/share/fonts/
          fc-cache -fv

      - name: Render Project
        working-directory: main-repo
        run: quarto render

      - name: Collect PDFs
        working-directory: main-repo
        run: |
          mkdir -p report_pdfs
          cp reports/*.pdf report_pdfs/

      - name: Zip PDFs
        working-directory: main-repo/report_pdfs
        run: zip -r ../report_pdfs.zip .

      # --- BRANCH SPECIFIC LOGIC STARTS HERE ---

      # CASE 1: Test Branch -> Upload Artifact (Temporary)
      - name: Upload Artifact (Test Branch)
        if: startsWith(github.ref, 'refs/heads/test')
        uses: actions/upload-artifact@v4
        with:
          name: report_pdfs.zip
          path: |
            main-repo/report_pdfs/*.pdf
          retention-days: 14

      # CASE 2: Main Branch -> Create Release (Permanent)
      - name: Generate Release Tag
        if: github.ref == 'refs/heads/main'
        id: tag
        run: |
          echo "release_tag=$(date +'%Y-%m-%d')-$(git -C main-repo rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Release (Main Branch)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: Report Build ${{ steps.tag.outputs.release_tag }}
          files: |
            main-repo/report_pdfs/*.pdf
            main-repo/report_pdfs.zip
          draft: false
          prerelease: true
          overwrite_files: true 
