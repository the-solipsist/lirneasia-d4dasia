name: Render and Publish Reports

on:
  push:
    # Trigger on main AND any branch starting with "test"
    branches: [ 'main', 'test*' ]
    paths:
      - 'reports/**/*.qmd'
      - '_quarto.yml'
      - '_extensions/**'
      - 'shared/**'
      - '_scripts/**'
      - '.github/workflows/publish-reports.yml'
  workflow_dispatch:

permissions:
  contents: write # Required for releases

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: pre-release

      - name: Render Project
        working-directory: main-repo
        run: quarto render

      - name: Collect PDFs
        working-directory: main-repo
        run: |
          mkdir -p d4dasia_report-pdfs
          cp report_pdfs/*.pdf d4dasia_report-pdfs/

      - name: Zip PDFs
        working-directory: main-repo/d4dasia_report-pdfs
        run: zip -r ../d4dasia_report-pdfs.zip .

      # --- BRANCH SPECIFIC LOGIC STARTS HERE ---

      # CASE 1: Test Branch -> Upload Artifact (Temporary)
      - name: Upload Artifact (Test Branch)
        if: startsWith(github.ref, 'refs/heads/test')
        uses: actions/upload-artifact@v4
        with:
          name: d4dasia_report-pdfs
          path: main-repo/d4dasia_report-pdfs/*.pdf
          retention-days: 14

      # CASE 2: Main Branch -> Create Release (Permanent)
      - name: Generate Release Tag
        if: github.ref == 'refs/heads/main'
        id: tag
        run: |
          echo "release_tag=$(date +'%Y-%m-%d')-$(git -C main-repo rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Release (Main Branch)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: Report Build ${{ steps.tag.outputs.release_tag }}
          files: |
            main-repo/d4dasia_report-pdfs/*.pdf
            main-repo/d4dasia_report-pdfs.zip
          draft: false
          prerelease: true
          overwrite_files: true 
