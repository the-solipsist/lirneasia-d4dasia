name: Render and Publish Reports

on:
  push:
    # Trigger on main AND any branch starting with "test-"
    branches: [ 'main', 'test*' ]
    paths:
      - 'country/**/*.qmd'
      - '_quarto.yml'
      - '_extensions/**'
      - 'shared/**'
      - '_scripts/**'
      - '.github/workflows/publish-reports.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true 

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: pre-release

      - name: Prepare Scripts
        run: chmod +x _scripts/link-pdfs.sh

      - name: Install Custom Fonts
        run: |
          sudo apt-get update && sudo apt-get install -y fontconfig
          mkdir -p ~/.local/share/fonts

          # Copy flat list of fonts to system directory
          cp -r _extensions/lirneasia/assets/fonts/* ~/.local/share/fonts/

          fc-cache -fv
          
          # Debug: Check for one of the new fonts (e.g., Bitter)
          echo "Checking for Bitter..."
          fc-list | grep "Bitter" || echo "‚ö†Ô∏è Font not found in fc-list"

      - name: Render Project
        run: quarto render

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -f reports/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Auto-generated PDF reports"
            git push
          fi
